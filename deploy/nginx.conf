# user  nginx;  # macOS上注释掉，使用默认用户
worker_processes  2;

error_log  /opt/homebrew/var/log/nginx/error.log notice;
pid        /opt/homebrew/var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /opt/homebrew/etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format main '$remote_addr | $remote_user | $time_local | "$request" | '
                   '$status | $body_bytes_sent | "$http_referer" | '
                   '"$http_user_agent" | "$http_x_forwarded_for" | '
                   '"$http_traceparent" | "$http_tracestate" | "$upstream_addr" | '
                   '"$http_mcp_session_id" | "$http_mcp_protocol_version" | "$http_last_event_id"';
    access_log  /opt/homebrew/var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;
    client_max_body_size 10m;

    # 接受带下划线的 header，必须在 http block 中设置
    underscores_in_headers on;  # 可识别 mcp-session-id 等 header
    
    # SSE流式传输优化配置
    gzip off;                   # 禁用gzip，SSE需要实时传输
    tcp_nopush off;             # 关闭tcp_nopush以支持实时传输  
    tcp_nodelay on;             # 启用tcp_nodelay以减少延迟

    server {
        listen 28083 default_server;

        # (可选) 自己的 Nginx 健康检查
        location = /nginx-health {
            return 200 'ok';
            add_header Content-Type text/plain;
        }

        # 其它所有请求：原样转发到本地MCP服务
        location / {
            # 修改为本地地址，MCP服务运行在localhost:8000
            proxy_pass http://localhost:8080;
            proxy_http_version 1.1;                  # 必须！HTTP/1.1对SSE很重要
            
            # SSE流式传输关键配置
            proxy_buffering off;                     # 禁用响应缓冲
            proxy_request_buffering off;             # 禁用请求缓冲
            proxy_cache off;                         # 禁用缓存
            proxy_read_timeout 86400;                # 24小时超时
            proxy_send_timeout 86400;                # 24小时超时
            proxy_connect_timeout 4;                 # 连接超时4秒
            
            # SSE专用配置
            proxy_max_temp_file_size 0;              # 禁用临时文件
            proxy_set_header Connection "";          # 让后端控制连接
            
            # 强制禁用nginx缓冲以支持SSE实时流
            proxy_set_header X-Accel-Buffering no;

            # 基础header设置
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;

            # 让nginx自动传递所有其他headers，包括MCP相关的headers
            # 不显式设置MCP headers，让nginx透传原始请求中的headers

            # 其余 header 不要写 proxy_set_header，Nginx 会自动透传
        }
    }
}

stream {
    # 原有 TCP 代理配置保留（如果需要的话）
    server {
        listen 25432;
        proxy_connect_timeout 2s;
        proxy_timeout 300s;
        proxy_pass pgm-uf6l23qwn8y635k6.pg.rds.aliyuncs.com:5432;
    }
    server {
        listen 26379;
        proxy_connect_timeout 2s;
        proxy_timeout 300s;
        proxy_pass r-uf6jfd1oy1opnnmo0f.redis.rds.aliyuncs.com:6379;
    }
} 