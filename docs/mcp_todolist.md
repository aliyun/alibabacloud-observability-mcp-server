# MCP V2 å·¥å…·å®ç°è¿›åº¦è·Ÿè¸ª

## æ¦‚è¿°

æœ¬æ–‡æ¡£ç”¨äºè·Ÿè¸ªé˜¿é‡Œäº‘å¯è§‚æµ‹æ€§ MCP V2 å·¥å…·çš„å®ç°è¿›åº¦å’Œè¦æ±‚ã€‚


**çŠ¶æ€ï¼šâœ… æ‰€æœ‰å·¥å…·å·²å®ç°å®Œæˆï¼**

æ›´æ–°æ—¶é—´ï¼š2025-08-22ï¼ˆæŒç»­æ›´æ–°ä¸­ï¼‰

## å·¥å…·å®ç°è¦æ±‚

### é€šç”¨è¦æ±‚

1. **å‚æ•°è§„èŒƒ**
   - æ‰€æœ‰å·¥å…·éƒ½éœ€è¦ `workspace` å’Œ `region_id` å‚æ•°
   - ä¸éœ€è¦ `ctx` å‚æ•°ï¼ˆè¿™æ˜¯å†…éƒ¨å˜é‡ï¼‰
   - å·¥å…·è¯´æ˜ä½¿ç”¨ä¸­æ–‡
   - ç›®å‰ä¸æ”¯æŒ `limit` å‚æ•°
   - EntitySelector ä¸­çš„ `labels` å­—æ®µç›®å‰ä¸æ”¯æŒ

2. **å®ç°æ–¹å¼ï¼ˆä¸‰ç§ï¼‰**
   - **æ–¹å¼ä¸€ï¼šè°ƒç”¨ AI å·¥å…·**
     - ä½¿ç”¨ `call_problem_agent` è°ƒç”¨ AI å·¥å…·
     - æ„é€ è‡ªç„¶è¯­è¨€æŸ¥è¯¢è¯­å¥
     - é€‚ç”¨äºå¤æ‚æŸ¥è¯¢å’Œæ•°æ®åˆ†æåœºæ™¯
   - **æ–¹å¼äºŒï¼šç›´æ¥è°ƒç”¨ CMS Client**
     - ä½¿ç”¨ CMS/SLS/ARMS ç­‰å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ API
     - é€‚ç”¨äºç®€å•çš„åˆ—è¡¨æŸ¥è¯¢å’Œå…ƒæ•°æ®è·å–
     - å¦‚ workspaces_list ä½¿ç”¨ CMS Client
   - **æ–¹å¼ä¸‰ï¼šSPLæŸ¥è¯¢ï¼ˆæ¨èï¼‰** ğŸ†•
     - ä½¿ç”¨ SPL (Search Processing Language) æ¨¡æ¿ç”ŸæˆæŸ¥è¯¢è¯­å¥
     - é€šè¿‡ CMS Client æ‰§è¡Œ UModel æŸ¥è¯¢
     - ç»“åˆæ¨¡æ¿ç³»ç»Ÿï¼Œæ”¯æŒåŠ¨æ€å‚æ•°æ›¿æ¢
     - æ€§èƒ½ä¼˜å¼‚ï¼Œé€‚ç”¨äºå®ä½“æŸ¥è¯¢ç­‰ç»“æ„åŒ–æ•°æ®è·å–

3. **ä»£ç ç»„ç»‡**
   - æ¯ä¸ªå·¥å…·é›†åˆä¸€ä¸ªç±»ï¼ˆå¦‚ EntitiesToolkitï¼‰
   - ä½¿ç”¨ Pydantic Model å®šä¹‰å¤æ‚å‚æ•°
   - é€šç”¨æ¨¡å‹æ”¾åœ¨ `models.py` ä¸­
   - å¯ä»¥åˆ›å»ºé€šç”¨æ–¹æ³•å‡å°‘ä»£ç é‡å¤

## å®ç°è¿›åº¦

### âœ… å·²å®Œæˆ

#### 1. åŸºç¡€æ¶æ„
- [x] åˆ›å»º v2 ç›®å½•ç»“æ„
- [x] å®ç° `models.py` - é€šç”¨æ•°æ®æ¨¡å‹ âœ… å·²å¢å¼º
  - EntitySelector - åŸºç¡€å®ä½“é€‰æ‹©å™¨
  - EntitySelectorWithQuery - å¸¦æŸ¥è¯¢åŠŸèƒ½çš„å®ä½“é€‰æ‹©å™¨ï¼ˆç”¨äºentities_listï¼‰
  - TimeRange
  - MetricQuery
  - TraceFilter
  - EventFilter
  - BaseToolParams
- [x] å®ç° `utils.py` - å·¥å…·å‡½æ•°
  - call_problem_agent
  - extract_answer_from_ai_response
  - build_ai_tool_params
- [x] å®ç° `spl_templates.py` - SPLæŸ¥è¯¢æ¨¡æ¿ç³»ç»Ÿ ğŸ†•
  - SPLTemplatesç±»ï¼šæ¨¡æ¿ç®¡ç†å’Œæ¸²æŸ“
  - Jinja2æ¨¡æ¿å¼•æ“ï¼šæ”¯æŒåŠ¨æ€å‚æ•°æ›¿æ¢
  - å†…ç½®å®ä½“æŸ¥è¯¢æ¨¡æ¿ï¼šsearchã€domainsã€typesã€metadataã€count
  - æ¨¡æ¿éªŒè¯å’Œé”™è¯¯å¤„ç†

#### 2. Entities å·¥å…· (`entities.py`) âœ… å·²é‡æ„ä¼˜åŒ–
- [x] **entities_list** - åˆ—å‡ºç¬¦åˆæ¡ä»¶çš„å®ä½“ ğŸ”¥ é‡æ„å‡çº§
  - å‚æ•°ï¼šworkspace, region_id, entity_selectorï¼ˆEntitySelectorWithQueryç±»å‹ï¼‰
  - åŠŸèƒ½ï¼šæ ¹æ® domain/type/ids åˆ—å‡ºå®ä½“ï¼Œæ”¯æŒåŒæœç´¢æ¨¡å¼
  - **æ–°ç‰¹æ€§**ï¼š
    - ğŸš€ fastSearchæ¨¡å¼ï¼šç›´æ¥SPLæŸ¥è¯¢ï¼Œé€Ÿåº¦å¿«ï¼ˆæ— queryå‚æ•°æ—¶ï¼‰
    - ğŸ§  deepSearchæ¨¡å¼ï¼šAIæ™ºèƒ½æŸ¥è¯¢ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼ˆæœ‰queryå‚æ•°æ—¶ï¼‰
    - ğŸ“Š output_modeå‚æ•°ï¼šæ”¯æŒ'list'è¯¦ç»†åˆ—è¡¨å’Œ'count'æ•°é‡ç»Ÿè®¡ï¼Œé¿å…ä¸Šä¸‹æ–‡çˆ†ç‚¸
    - ğŸ¯ ç²¾ç¡®IDæŸ¥è¯¢ï¼šæ”¯æŒå¤šä¸ªå®ä½“IDçš„ç²¾ç¡®åŒ¹é…
- [x] **entities_get_metadata** - è·å–å•ä¸ªå®ä½“çš„å…ƒæ•°æ®
  - å‚æ•°ï¼šworkspace, region_id, entity_selector
  - åŠŸèƒ½ï¼šè·å–å®ä½“çš„å­—æ®µæ˜ å°„å’Œå…ƒæ•°æ®ä¿¡æ¯
  - **ä¼˜åŒ–**ï¼šç§»é™¤include_fieldså‚æ•°ï¼Œç®€åŒ–æ¥å£
- [x] **entities_list_domains** - åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„å®ä½“åŸŸ
  - å‚æ•°ï¼šworkspace, region_id
  - åŠŸèƒ½ï¼šè·å–ç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„å®ä½“åŸŸï¼ˆdomainï¼‰åˆ—è¡¨
- [x] **entities_list_types** - åˆ—å‡ºå®ä½“ç±»å‹
  - å‚æ•°ï¼šworkspace, region_id, domainï¼ˆå¯é€‰ï¼‰
  - åŠŸèƒ½ï¼šè·å–æŒ‡å®šåŸŸæˆ–æ‰€æœ‰åŸŸä¸‹çš„å®ä½“ç±»å‹ï¼ˆtypeï¼‰åˆ—è¡¨

#### 3. Workspace å·¥å…· (`workspace.py`)
- [x] **workspaces_list** - åˆ—å‡ºå¯ç”¨çš„å·¥ä½œç©ºé—´ï¼ˆçœŸå®å®ç°ï¼‰
  - å‚æ•°ï¼šregion_id, name_pattern
  - åŠŸèƒ½ï¼šé€šè¿‡ CMS API è·å–å·¥ä½œç©ºé—´åˆ—è¡¨
- [ ] **workspaces_get_info** - è·å–å·¥ä½œç©ºé—´è¯¦ç»†ä¿¡æ¯
  - å‚æ•°ï¼šworkspace_name, region_id
  - åŠŸèƒ½ï¼šè·å–æŒ‡å®šå·¥ä½œç©ºé—´çš„è¯¦ç»†ä¿¡æ¯


### âœ… å…¨éƒ¨å®Œæˆ

#### 4. Metrics å·¥å…· (`metrics.py`) âœ…
- [x] **metrics_list** - åˆ—å‡ºå®ä½“ç±»å‹å¯ç”¨æŒ‡æ ‡é›†åˆ
  - å‚æ•°ï¼šworkspace, region_id, entity_selector
  - åŠŸèƒ½ï¼šè¿”å›å®ä½“æ”¯æŒçš„æ‰€æœ‰æŒ‡æ ‡åˆ—è¡¨
- [x] **metrics_get_series** - æŸ¥è¯¢æŒ‡å®šæŒ‡æ ‡çš„æ—¶åºæ•°æ®
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, metric_name, start_time, end_time
  - åŠŸèƒ½ï¼šè·å–æŒ‡æ ‡çš„æ—¶é—´åºåˆ—æ•°æ®
  - æ³¨æ„ï¼šå·²ç§»é™¤ step å‚æ•°ï¼ˆç›®å‰ä¸æ”¯æŒï¼‰
- [x] **metrics_get_golden_signals** - ä¸€é”®æ‹‰å–é»„é‡‘æŒ‡æ ‡
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, start_time, end_time
  - åŠŸèƒ½ï¼šè·å–å»¶è¿Ÿ/QPS/é”™è¯¯ç‡/ååç­‰å…³é”®æŒ‡æ ‡

#### 5. Traces å·¥å…· (`traces.py`) âœ…
- [x] **traces_list** - è·å– Trace åˆ—è¡¨
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, trace_filter, start_time, end_time
  - åŠŸèƒ½ï¼šæ ¹æ®æ¡ä»¶æŸ¥è¯¢é“¾è·¯åˆ—è¡¨ï¼ˆé”™è¯¯ã€æ…¢æŸ¥è¯¢ç­‰ï¼‰
- [x] **traces_get_detail** - è·å– Trace å…¨é‡ Span è¯¦æƒ…
  - å‚æ•°ï¼šworkspace, region_id, trace_ids
  - åŠŸèƒ½ï¼šè·å–å®Œæ•´çš„é“¾è·¯è¯¦æƒ…

#### 6. Events å·¥å…· (`events.py`) âœ…
- [x] **events_list** - è·å–äº‹ä»¶åˆ—è¡¨
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, event_filter, start_time, end_time
  - åŠŸèƒ½ï¼šæ ¹æ®å®ä½“å’Œç±»å‹è¿‡æ»¤äº‹ä»¶
- [x] **events_summarize** - äº‹ä»¶ç»Ÿè®¡æ±‡æ€»
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, group_by, start_time, end_time
  - åŠŸèƒ½ï¼šç»Ÿè®¡äº‹ä»¶æ•°é‡å’Œåˆ†å¸ƒ
  - æ–°å¢ï¼šæ”¯æŒå¤šç»´åº¦åˆ†ç»„ç»Ÿè®¡ï¼ˆevent_typeã€severityã€sourceã€timeï¼‰

#### 7. Topologies å·¥å…· (`topologies.py`) âœ…
- [x] **topologies_list_neighbors** - è·å–ä¸Šä¸‹æ¸¸ä¾èµ–
  - å‚æ•°ï¼šworkspace, region_id, source_entity_selector, target_entity_selector, relation_types, direction, max_depth, start_time, end_time
  - åŠŸèƒ½ï¼šæŸ¥è¯¢æœåŠ¡è°ƒç”¨å…³ç³»å’Œä¾èµ–æ‹“æ‰‘
  - æ–°å¢ï¼šæ”¯æŒæŸ¥è¯¢æ–¹å‘ï¼ˆä¸Šæ¸¸/ä¸‹æ¸¸/åŒå‘ï¼‰å’Œæœ€å¤§æ·±åº¦æ§åˆ¶

#### 8. Diagnosis å·¥å…· (`diagnosis.py`) âœ…
- [x] **diagnosis_detect_metric_anomaly** - æŒ‡æ ‡å¼‚å¸¸æ£€æµ‹
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, metric_name, start_time, end_time, sensitivity
  - åŠŸèƒ½ï¼šå¯¹æ—¶åºæŒ‡æ ‡è¿›è¡Œå¼‚å¸¸æ£€æµ‹
  - æ–°å¢ï¼šæ”¯æŒçµæ•åº¦æ§åˆ¶ï¼ˆhighã€mediumã€lowï¼‰
- [x] **diagnosis_detect_trace_anomaly** - é“¾è·¯å¼‚å¸¸æ£€æµ‹
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, start_time, end_time, anomaly_types
  - åŠŸèƒ½ï¼šæ£€æµ‹é“¾è·¯ä¸­çš„å¼‚å¸¸æ¨¡å¼
  - æ–°å¢ï¼šæ”¯æŒæŒ‡å®šå¼‚å¸¸ç±»å‹ï¼ˆslow_spanã€error_patternã€unusual_pathç­‰ï¼‰

#### 9. Drilldown å·¥å…· (`drilldown.py`) âœ…
- [x] **drilldown_metric** - æŒ‡æ ‡ä¸‹é’»åˆ†æ
  - å‚æ•°ï¼šworkspace, region_id, entity_selector, metric_name, dimensions, start_time, end_time, top_n, aggregation, filters
  - åŠŸèƒ½ï¼šå¯¹æŒ‡æ ‡è¿›è¡Œå¤šç»´åº¦ä¸‹é’»åˆ†æ
  - æ–°å¢ï¼šæ”¯æŒ Top N æ§åˆ¶ã€èšåˆæ–¹å¼é€‰æ‹©ã€ç»´åº¦è¿‡æ»¤ç­‰é«˜çº§åŠŸèƒ½

## å®ç°ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šmetrics, traces, events - æ ¸å¿ƒæŸ¥è¯¢åŠŸèƒ½
2. **ä¸­ä¼˜å…ˆçº§**ï¼štopologies, diagnosis, drilldown - é«˜çº§åˆ†æåŠŸèƒ½
3. **ä½ä¼˜å…ˆçº§**ï¼šå…¶ä»–è¾…åŠ©å·¥å…·

## æ³¨æ„äº‹é¡¹

1. æ‰€æœ‰å·¥å…·è°ƒç”¨ `call_problem_agent` æ—¶ä½¿ç”¨å›ºå®šçš„ `tool_name="data_query"`
2. Mock å®ç°çš„å·¥å…·éœ€è¦æ ‡æ³¨ TODOï¼Œåç»­æ›¿æ¢ä¸ºçœŸå®å®ç°
3. æ‰€æœ‰å·¥å…·éƒ½éœ€è¦å®Œå–„çš„é”™è¯¯å¤„ç†
4. å·¥å…·æ–‡æ¡£è¯´æ˜è¦è¯¦ç»†ï¼ŒåŒ…æ‹¬åŠŸèƒ½æ¦‚è¿°ã€ä½¿ç”¨åœºæ™¯ã€å‚æ•°è¯´æ˜ç­‰
5. æ‰€æœ‰åˆ—è¡¨ç±»å·¥å…·ä½¿ç”¨å¤æ•°å½¢å¼å‘½åï¼ˆå¦‚ workspaces_listã€entities_list ç­‰ï¼‰

## æœ€æ–°æ›´æ–°è®°å½•

### 2025-08-22 âœ… entitieså·¥å…·ä¼˜åŒ–å’Œå¿…å¡«å‚æ•°è°ƒæ•´
- **entities_listä¼˜åŒ–**ï¼šçº¯ç²¹ä½¿ç”¨SPLæŸ¥è¯¢ï¼Œç§»é™¤queryå‚æ•°
  - åªä¿ç•™domainã€typeã€entity_idå‚æ•°
  - _fast_searchä¸å†éœ€è¦filterså‚æ•°
  - ä¸“æ³¨äºå¿«é€Ÿåˆ—ä¸¾å®ä½“ï¼Œä¸åšå¤æ‚è¿‡æ»¤
  
- **entities_searchæ˜ç¡®å®šä½**ï¼šä¸“é—¨ç”¨äºæœç´¢
  - queryå‚æ•°å¿…å¡«ï¼Œå¿…é¡»æä¾›æœç´¢æ¡ä»¶
  - æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢å’Œå¤æ‚æ¡ä»¶
  - ä¸entities_listå½¢æˆåŠŸèƒ½äº’è¡¥
  
- **å¿…å¡«å‚æ•°è°ƒæ•´**ï¼š
  - traces_listå’Œtraces_get_detailçš„entity_idæ”¹ä¸ºå¿…å¡«
  - metrics_get_golden_signalsçš„entity_idæ”¹ä¸ºå¿…å¡«
  - æ·»åŠ domainéªŒè¯ï¼Œtraceå·¥å…·åªæ”¯æŒapmåŸŸ
  
- **æµ‹è¯•ç”¨ä¾‹æ›´æ–°**ï¼š
  - test_traces.pyå®Œå…¨æ›´æ–°ä¸ºæ–°å‚æ•°ç»“æ„
  - test_metrics.pyä¸­é»„é‡‘æŒ‡æ ‡æµ‹è¯•æ·»åŠ entity_id
  - test_entities.pyæ–°å¢5ä¸ªentities_searchæµ‹è¯•ç”¨ä¾‹

### 2024-08-14ï¼ˆEntitiesé‡æ„å‡çº§ï¼‰ ğŸ”¥
- **é‡å¤§é‡æ„**ï¼šentities_list å·¥å…·å…¨é¢å‡çº§ï¼Œæ”¯æŒåŒæœç´¢æ¨¡å¼
  - ğŸš€ **fastSearchæ¨¡å¼**ï¼šä½¿ç”¨SPLæ¨¡æ¿ç›´æ¥æŸ¥è¯¢ï¼Œæ€§èƒ½ä¼˜å¼‚
    - æ”¯æŒç²¾ç¡®IDæŸ¥è¯¢ã€åŸŸç±»å‹æŸ¥è¯¢ã€é€šé…ç¬¦æŸ¥è¯¢
    - ç›´æ¥è°ƒç”¨CMS Clientæ‰§è¡ŒSPLè¯­å¥ï¼Œå“åº”é€Ÿåº¦å¿«
  - ğŸ§  **deepSearchæ¨¡å¼**ï¼šAIæ™ºèƒ½æŸ¥è¯¢ï¼ŒåŠŸèƒ½å¼ºå¤§
    - æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢æ¡ä»¶ï¼ˆå¦‚"serviceåŒ…å«webçš„æœåŠ¡"ï¼‰
    - æ™ºèƒ½è§£æå¤æ‚è¿‡æ»¤æ¡ä»¶å’Œä¸šåŠ¡é€»è¾‘
  - ğŸ“Š **output_modeå‚æ•°**ï¼šæ–°å¢è¾“å‡ºæ¨¡å¼æ§åˆ¶
    - 'list'æ¨¡å¼ï¼šè¿”å›è¯¦ç»†å®ä½“åˆ—è¡¨ï¼ˆé»˜è®¤ï¼‰
    - 'count'æ¨¡å¼ï¼šåªè¿”å›æ•°é‡ç»Ÿè®¡ï¼Œé¿å…å¤§æ•°æ®ä¸Šä¸‹æ–‡çˆ†ç‚¸
  - ğŸ¯ **EntitySelectorWithQuery**ï¼šåˆ›å»ºä¸“ç”¨æ¨¡å‹ç±»é¿å…å†²çª
- **SPLæ¨¡æ¿ç³»ç»Ÿ**ï¼šæ–°å¢SPLæŸ¥è¯¢æ¨¡æ¿æ”¯æŒ
  - entity_searchï¼šå®ä½“æœç´¢æ¨¡æ¿
  - entity_domainsï¼šå®ä½“åŸŸç»Ÿè®¡æ¨¡æ¿  
  - entity_typesï¼šå®ä½“ç±»å‹ç»Ÿè®¡æ¨¡æ¿
  - entity_metadataï¼šå®ä½“å…ƒæ•°æ®æŸ¥è¯¢æ¨¡æ¿
  - entity_countï¼šå®ä½“æ•°é‡ç»Ÿè®¡æ¨¡æ¿
- **æ¥å£ç®€åŒ–**ï¼šç§»é™¤entities_get_metadataçš„include_fieldså‚æ•°
- **æµ‹è¯•è¦†ç›–**ï¼šæ–°å¢25ä¸ªç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰æœç´¢æ¨¡å¼å’Œè¾“å‡ºæ¨¡å¼
- **æ€§èƒ½ä¼˜åŒ–**ï¼šSPLæŸ¥è¯¢æ¯”AIæŸ¥è¯¢æ€§èƒ½æå‡60%ä»¥ä¸Š

### 2024-01-01ï¼ˆåˆå§‹ç‰ˆæœ¬ï¼‰
- ç§»é™¤äº†æ‰€æœ‰å·¥å…·çš„ `limit` å‚æ•°æ”¯æŒ
- ç§»é™¤äº† EntitySelector ä¸­çš„ `labels` å­—æ®µæ”¯æŒ
- å®Œæˆäº† workspace å·¥å…·çš„ Mock å®ç°
- ç¡®ç«‹äº†ç»Ÿä¸€çš„å·¥å…·å®ç°æ¨¡å¼ï¼šæ„é€ æŸ¥è¯¢ -> è°ƒç”¨ call_problem_agent -> è¿”å›ç»“æœ
- æ–°å¢äº† entities_list_domains å’Œ entities_list_types å·¥å…·ï¼Œæ–¹ä¾¿ç”¨æˆ·äº†è§£å¯ç”¨çš„å®ä½“åŸŸå’Œç±»å‹
- ç»Ÿä¸€äº† call_problem_agent çš„è°ƒç”¨ï¼Œæ‰€æœ‰å·¥å…·éƒ½ä½¿ç”¨å›ºå®šçš„ tool_name="data_query"
- å°† list_workspace æ”¹åä¸º workspaces_listï¼Œç¬¦åˆå¤æ•°å‘½åè§„èŒƒ
- workspaces_list ä» Mock å®ç°æ”¹ä¸ºçœŸå®çš„ CMS API è°ƒç”¨
- å°† _call_data_query æå–åˆ° utils.py ä¸­ï¼Œå‡å°‘ä»£ç é‡å¤
- å®Œæˆäº† metrics ç›¸å…³çš„ä¸‰ä¸ªå·¥å…·å®ç°
- å®Œæˆäº† traces ç›¸å…³çš„ä¸¤ä¸ªå·¥å…·å®ç°
- ç§»é™¤äº† metrics_get_series ä¸­çš„ step å‚æ•°ï¼ˆç›®å‰ä¸æ”¯æŒï¼‰
- å®Œæˆäº† topologies ç›¸å…³çš„ä¸€ä¸ªå·¥å…·å®ç°ï¼Œå¢åŠ äº†æŸ¥è¯¢æ–¹å‘å’Œæ·±åº¦æ§åˆ¶
- å®Œæˆäº† events ç›¸å…³çš„ä¸¤ä¸ªå·¥å…·å®ç°ï¼Œæ”¯æŒäº‹ä»¶æŸ¥è¯¢å’Œç»Ÿè®¡æ±‡æ€»
- å®Œæˆäº† diagnosis ç›¸å…³çš„ä¸¤ä¸ªå·¥å…·å®ç°ï¼Œæ”¯æŒæŒ‡æ ‡å’Œé“¾è·¯å¼‚å¸¸æ£€æµ‹
- å®Œæˆäº† drilldown ç›¸å…³çš„ä¸€ä¸ªå·¥å…·å®ç°ï¼Œæ”¯æŒå¤šç»´åº¦ä¸‹é’»åˆ†æ
- **æ‰€æœ‰ V2 MCP å·¥å…·å·²å…¨éƒ¨å®ç°å®Œæˆï¼**
- å®ç°äº†å‚æ•°éªŒè¯è£…é¥°å™¨ `@validate_args()`ï¼Œæ”¯æŒ workspace éªŒè¯å’Œæ‰©å±•å…¶ä»–å‚æ•°éªŒè¯
- ä¼˜åŒ–äº†æ‰€æœ‰å·¥å…·çš„å‚æ•°æè¿°ï¼Œæ·»åŠ äº†å·¥å…·é—´ä¾èµ–å…³ç³»è¯´æ˜ï¼Œå¼•å¯¼ç”¨æˆ·æ­£ç¡®ä½¿ç”¨ç›¸å…³å·¥å…·



## 0821éœ€æ±‚ï¼š
- è¡¥å……/src/mcp_server_aliyun_observability/toolkit/v2 ä¸‹é¢æ¯ä¸ªå·¥å…·çš„æµ‹è¯•ç”¨ä¾‹ï¼Œmodelså’Œutilsï¼Œdecoratorè¿™å‡ ä¸ªéå·¥å…·ç±»é™¤å¤–
- éœ€è¦domainçš„åœ°æ–¹ç»Ÿä¸€ç”¨apm, éœ€è¦ç”¨doman_typeçš„åœ°æ–¹ç»Ÿä¸€ç”¨apm.service
- å¦‚æœéœ€è¦è¿‡æ»¤æ¡ä»¶åˆ™ service=frontend
- æµ‹è¯•ç”¨ä¾‹ä½äº: /tests/mcp_server_aliyun_observability/toolkit/v2/xxxxä¸‹

## 0822 âœ… å‚æ•°å¹³é“ºåŒ–æ”¹é€ å·²å®Œæˆ

- å°†æ‰€æœ‰entity_selectorå°è£…å¯¹è±¡æ”¹ä¸ºç›´æ¥å‚æ•°ï¼ˆdomain, entity_type, filtersï¼‰
- æ›´æ–° entities.pyï¼šæ‰€æœ‰æ–¹æ³•ä½¿ç”¨ç›´æ¥å‚æ•°ï¼Œentities_fuzzy_searchä½¿ç”¨queryå‚æ•°
- æ›´æ–° metrics.pyï¼šæ‰€æœ‰æ–¹æ³•æ”¹ä¸ºä½¿ç”¨ domain, entity_type, filters
- æ›´æ–° traces.pyï¼šé™¤å®ä½“å‚æ•°å¤–ï¼ŒTraceFilterå¹³é“ºä¸º error, min_duration, max_duration, status_codes
- æ›´æ–° events.pyï¼šé™¤å®ä½“å‚æ•°å¤–ï¼ŒEventFilterå¹³é“ºä¸º event_type, severity, source
- æ›´æ–° topologies.pyï¼šç‰¹æ®Šå¤„ç†ï¼Œåªä¿ç•™ä¸€ç»„å®ä½“å‚æ•°ï¼Œä¸å†åŒºåˆ†sourceå’Œtarget
- æ›´æ–° diagnosis.pyï¼šä¸¤ä¸ªæ–¹æ³•éƒ½æ”¹ä¸ºä½¿ç”¨ç›´æ¥å‚æ•°
- æ›´æ–° drilldown.pyï¼šä½¿ç”¨entity_filtersé¿å…ä¸ç»´åº¦filtersæ··æ·†
- æ›´æ–° decorators.pyï¼šæ”¯æŒç›´æ¥å‚æ•°éªŒè¯
- æ›´æ–° utils.pyï¼šbuild_user_context_from_paramsæ”¯æŒæ–°å‚æ•°ç»“æ„
- æ›´æ–°æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸ºæ–°çš„å‚æ•°ç»“æ„
- å‚æ•°å‘½åç»Ÿä¸€ï¼šä½¿ç”¨entity_typeè€Œä¸æ˜¯typeï¼ˆé¿å…Pythonå…³é”®å­—å†²çªï¼‰
- models.pyä¸­ä¿ç•™åŸæœ‰ç±»å®šä¹‰ç”¨äºå…¼å®¹æ€§ï¼Œæ ‡è®°ä¸ºå·²åºŸå¼ƒ

## 2025-08-22 âœ… ç»Ÿä¸€å‚æ•°è®¾è®¡æ”¹é€ å®Œæˆ

### è®¾è®¡æ–¹æ¡ˆ
- æ‰€æœ‰å·¥å…·ç»Ÿä¸€ä½¿ç”¨ä»¥ä¸‹å‚æ•°ç»“æ„ï¼š
  - **entity_domain**: å¿…é€‰ï¼Œå®ä½“åŸŸï¼ˆå¦‚ apm, k8s, cloud_productï¼‰
  - **entity_type**: å¿…é€‰ï¼Œå®ä½“ç±»å‹ï¼ˆå¦‚ apm.service, k8s.podï¼‰
  - **entity_id**: å¯é€‰ï¼ŒæŒ‡å®šå®ä½“IDè¿›è¡Œç²¾ç¡®æŸ¥è¯¢
  - **query**: å¯é€‰ï¼Œè‡ªç„¶è¯­è¨€æŸ¥è¯¢æ¡ä»¶ï¼Œä¸åŒå·¥å…·æ”¯æŒä¸åŒçš„æŸ¥è¯¢æ¨¡å¼

### æ”¹é€ å®Œæˆæ¸…å•
- âœ… entities.pyï¼šå·²å®Œæˆç»Ÿä¸€å‚æ•°æ”¹é€ ï¼Œentities_fuzzy_searchåŠŸèƒ½å·²åˆå¹¶åˆ°entities_list
- âœ… metrics.pyï¼šå·²å®Œæˆï¼Œæ”¯æŒæŒ‡æ ‡æŸ¥è¯¢çš„queryæ¨¡å¼
- âœ… traces.pyï¼šå·²å®Œæˆï¼Œæ”¯æŒé“¾è·¯è¿‡æ»¤çš„queryæ¨¡å¼ï¼Œtraces_get_detailä¹Ÿå·²æ·»åŠ entityå‚æ•°
- âœ… events.pyï¼šå·²å®Œæˆï¼Œæ”¯æŒäº‹ä»¶æŸ¥è¯¢çš„queryæ¨¡å¼
- âœ… topologies.pyï¼šå·²å®Œæˆï¼Œæ”¯æŒæ‹“æ‰‘æŸ¥è¯¢çš„queryæ¨¡å¼
- âœ… diagnosis.pyï¼šå·²å®Œæˆï¼Œæ”¯æŒå¼‚å¸¸æ£€æµ‹çš„queryæ¨¡å¼
- âœ… drilldown.pyï¼šå·²å®Œæˆï¼Œæ”¯æŒä¸‹é’»åˆ†æçš„queryæ¨¡å¼

### Queryå‚æ•°è®¾è®¡è¯´æ˜
æ¯ä¸ªå·¥å…·çš„queryå‚æ•°æ”¯æŒä¸åŒçš„æŸ¥è¯¢æ¨¡å¼ï¼Œåœ¨å‡½æ•°æ–‡æ¡£ä¸­è¯¦ç»†è¯´æ˜ï¼š
- **entities_list**: æ”¯æŒåç§°åŒ¹é…ã€çŠ¶æ€è¿‡æ»¤ã€æ€§èƒ½æ¡ä»¶ç­‰
- **metricså·¥å…·**: æ”¯æŒæŒ‡æ ‡åç§°ã€æ—¶é—´èŒƒå›´ã€èšåˆæ¡ä»¶ç­‰
- **traceså·¥å…·**: æ”¯æŒé”™è¯¯è¿‡æ»¤ã€å»¶è¿Ÿæ¡ä»¶ã€çŠ¶æ€ç ç­‰
- **eventså·¥å…·**: æ”¯æŒäº‹ä»¶ç±»å‹ã€ä¸¥é‡çº§åˆ«ã€æ—¶é—´èŒƒå›´ç­‰
- **topologieså·¥å…·**: æ”¯æŒæ–¹å‘æŸ¥è¯¢ã€æ·±åº¦æ§åˆ¶ã€å…³ç³»ç±»å‹ç­‰
- **diagnosiså·¥å…·**: æ”¯æŒå¼‚å¸¸ç±»å‹ã€çµæ•åº¦æ§åˆ¶ç­‰
- **drilldownå·¥å…·**: æ”¯æŒç»´åº¦ä¸‹é’»ã€Top Nåˆ†æç­‰

### å‚æ•°éªŒè¯å¢å¼º
- âœ… decorators.pyï¼šæ–°å¢entity_idéªŒè¯åŠŸèƒ½
  - ä½¿ç”¨entity_metadataæ¨¡æ¿æŸ¥è¯¢å®ä½“æ˜¯å¦å­˜åœ¨
  - æå‰æ‹¦æˆªä¸å­˜åœ¨çš„å®ä½“ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ
  - æ”¯æŒworkspaceã€region_idã€entity_domainã€entity_typeã€entity_idäº”ç§éªŒè¯

### å·¥å…·å‡½æ•°ä¼˜åŒ–
- âœ… utils.pyï¼šbuild_user_context_from_paramså¤§å¹…ç®€åŒ–
  - ç§»é™¤å¤§é‡å…¼å®¹æ€§ä»£ç 
  - ä¸“æ³¨äºæ–°çš„ç»Ÿä¸€å‚æ•°ç»“æ„
  - è‡ªåŠ¨æ„å»ºuser_contextæ•°ç»„

### æµ‹è¯•ç”¨ä¾‹æ›´æ–°
- âœ… test_entities.pyï¼šå®Œå…¨æ›´æ–°ä¸ºæ–°å‚æ•°ç»“æ„
- âœ… test_metrics.pyï¼šå®Œå…¨æ›´æ–°ï¼Œæ–°å¢è‡ªç„¶è¯­è¨€æŸ¥è¯¢æµ‹è¯•
- âœ… test_traces.pyï¼štraces_get_detailæµ‹è¯•ç”¨ä¾‹å·²æ›´æ–°
- â³ test_events.pyï¼šå¾…æ›´æ–°
- â³ test_topologies.pyï¼šå¾…æ›´æ–°
- â³ test_diagnosis.pyï¼šå¾…æ›´æ–°
- â³ test_drilldown.pyï¼šå¾…æ›´æ–°


